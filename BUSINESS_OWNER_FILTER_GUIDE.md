# üö´ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–ª–∞–¥–µ–ª—å—Ü–∞ Business –∞–∫–∫–∞—É–Ω—Ç–∞

## üìã –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

–î–∞–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–º–æ–∂–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–ª–∞–¥–µ–ª—å—Ü–∞ Premium –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –ª—é–±–æ–º Telegram –±–æ—Ç–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Business API.

---

## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Telegram Business API –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç **–≤—Å–µ** —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞ - –∫–∞–∫ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–∞–∫ –∏ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –æ—Ç–≤–µ—Ç–æ–≤, –∫–æ–≥–¥–∞ –≤–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–≤–µ—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –≤—Ä—É—á–Ω—É—é, –∞ –±–æ—Ç —Ç–æ–∂–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.

### –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ Business –∞–∫–∫–∞—É–Ω—Ç–∞
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤

---

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- **Telegram Premium** –ø–æ–¥–ø–∏—Å–∫–∞ —É –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
- **Business API** –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram
- **Webhook** —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ (–Ω–µ polling)
- **Python 3.8+** –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —è–∑—ã–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π JSON

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
```python
import json
import logging
from collections import deque
from datetime import datetime
```

---

## üîß –ü–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤

```python
# –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ Business Connection
business_owners = {}  # {business_connection_id: owner_user_id}

# –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - —Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
last_updates = deque(maxlen=10)
update_counter = 0
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `business_owners` - –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- –ö–ª—é—á: `business_connection_id` (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
- –ó–Ω–∞—á–µ–Ω–∏–µ: `owner_user_id` (Telegram ID –≤–ª–∞–¥–µ–ª—å—Ü–∞)

### –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Business Connection —Å–æ–±—ã—Ç–∏–π

```python
def handle_business_connection(update_dict):
    \"\"\"
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ Business Connection
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    \"\"\"
    conn = update_dict[\"business_connection\"]
    is_enabled = conn.get(\"is_enabled\", False)
    connection_id = conn.get(\"id\")
    user_info = conn.get(\"user\", {})
    user_name = user_info.get(\"first_name\", \"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\")
    owner_user_id = user_info.get(\"id\")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ Business Connection –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    if connection_id and owner_user_id:
        if is_enabled:
            business_owners[connection_id] = owner_user_id
            logging.info(f\"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü Business Connection: {user_name} (ID: {owner_user_id}) –¥–ª—è connection_id: {connection_id}\")
        else:
            # –£–¥–∞–ª—è–µ–º –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
            business_owners.pop(connection_id, None)
            logging.info(f\"‚ùå –£–¥–∞–ª–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü Business Connection: {user_name} (connection_id: {connection_id})\")
    
    status = \"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω\" if is_enabled else \"‚ùå –û—Ç–∫–ª—é—á–µ–Ω\"
    logging.info(f\"{status} –∫ Business –∞–∫–∫–∞—É–Ω—Ç—É: {user_name}\")
    logging.info(f\"üìä –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö Business Connection: {len(business_owners)}\")
```

### –®–∞–≥ 3: –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞

```python
def is_message_from_owner(user_id, business_connection_id):
    \"\"\"
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º Business –∞–∫–∫–∞—É–Ω—Ç–∞
    
    Args:
        user_id: ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
        business_connection_id: ID Business —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        
    Returns:
        bool: True –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞, False –µ—Å–ª–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
    \"\"\"
    if not business_connection_id or business_connection_id not in business_owners:
        # –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç
        return False
        
    owner_id = business_owners[business_connection_id]
    return str(user_id) == str(owner_id)
```

### –®–∞–≥ 4: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Business Messages —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

```python
def handle_business_message(update_dict):
    \"\"\"
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Business —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞
    \"\"\"
    bus_msg = update_dict[\"business_message\"]
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    chat_id = bus_msg[\"chat\"][\"id\"]
    text = bus_msg.get(\"text\", \"\") or bus_msg.get(\"caption\", \"\")
    user_id = bus_msg.get(\"from\", {}).get(\"id\", \"unknown\")
    business_connection_id = bus_msg.get(\"business_connection_id\")
    user_name = bus_msg.get(\"from\", {}).get(\"first_name\", \"–ö–ª–∏–µ–Ω—Ç\")
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    logging.info(f\"üìä Business message - connection_id: '{business_connection_id}'\")
    logging.info(f\"üë§ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç: {user_name} (ID: {user_id})\")
    
    # üö´ –ö–†–ò–¢–ò–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
    if is_message_from_owner(user_id, business_connection_id):
        logging.info(f\"üö´ –ò–ì–ù–û–†–ò–†–£–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞: {user_name} (ID: {user_id})\")
        logging.info(f\"üí¨ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: '{text[:100]}{'...' if len(text) > 100 else ''}'\")\n        return {\"ok\": True, \"action\": \"ignored_owner_message\", \"reason\": \"message_from_business_owner\"}\n    else:\n        logging.info(f\"‚úÖ –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞: {user_name} (ID: {user_id})\")\n    \n    # –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ, –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ\n    if not business_connection_id or business_connection_id not in business_owners:\n        logging.warning(f\"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü –¥–ª—è connection_id: {business_connection_id}. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ.\")\n        logging.info(f\"üìä –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–ª–∞–¥–µ–ª—å—Ü—ã: {list(business_owners.keys())}\")\n    \n    # ‚úÖ –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï –û–¢ –ö–õ–ò–ï–ù–¢–ê\n    # –ó–¥–µ—Å—å –≤–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\n    return process_client_message(chat_id, text, user_name, business_connection_id)\n\n\ndef process_client_message(chat_id, text, user_name, business_connection_id):\n    \"\"\"–í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤\"\"\"\n    # –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏\n    response = f\"–ü—Ä–∏–≤–µ—Ç, {user_name}! –ü–æ–ª—É—á–∏–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {text}\"\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Business API\n    return send_business_message(chat_id, response, business_connection_id)\n```\n\n### –®–∞–≥ 5: –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Business API\n\n```python\ndef send_business_message(chat_id, text, business_connection_id):\n    \"\"\"\n    –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Business API\n    (pyTelegramBotAPI –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç business_connection_id)\n    \"\"\"\n    import requests\n    \n    BOT_TOKEN = \"YOUR_BOT_TOKEN\"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω\n    url = f\"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage\"\n    data = {\n        \"chat_id\": chat_id,\n        \"text\": text,\n        \"business_connection_id\": business_connection_id\n    }\n    \n    try:\n        response = requests.post(url, json=data, timeout=10)\n        result = response.json()\n        \n        if result.get(\"ok\"):\n            logging.info(f\"‚úÖ Business API: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ HTTP API\")\n            return result.get(\"result\")\n        else:\n            logging.error(f\"‚ùå Business API –æ—à–∏–±–∫–∞: {result}\")\n            return None\n    except Exception as e:\n        logging.error(f\"‚ùå Business API HTTP –æ—à–∏–±–∫–∞: {e}\")\n        return None\n```\n\n### –®–∞–≥ 6: –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook\n\n```python\ndef process_webhook(update_dict):\n    \"\"\"\n    –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞\n    \"\"\"\n    global update_counter\n    update_counter += 1\n    \n    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è\n    if \"business_connection\" in update_dict:\n        handle_business_connection(update_dict)\n        \n    elif \"business_message\" in update_dict:\n        return handle_business_message(update_dict)\n        \n    elif \"message\" in update_dict:\n        # –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ Business)\n        return handle_regular_message(update_dict)\n        \n    return {\"ok\": True, \"status\": \"processed\", \"update_id\": update_counter}\n```\n\n---\n\n## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook\n\n### –¢—Ä–µ–±—É–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è webhook:\n\n```python\nallowed_updates = [\n    \"message\",\n    \"business_connection\", \n    \"business_message\",\n    \"edited_business_message\",\n    \"deleted_business_messages\"\n]\n```\n\n### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook:\n\n```python\nimport requests\n\ndef set_webhook(bot_token, webhook_url, secret_token):\n    url = f\"https://api.telegram.org/bot{bot_token}/setWebhook\"\n    data = {\n        \"url\": webhook_url,\n        \"secret_token\": secret_token,\n        \"allowed_updates\": [\n            \"message\",\n            \"business_connection\", \n            \"business_message\",\n            \"edited_business_message\",\n            \"deleted_business_messages\"\n        ]\n    }\n    \n    response = requests.post(url, json=data)\n    return response.json()\n```\n\n---\n\n## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞\n\n### Endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n\n```python\ndef get_business_owners_status():\n    \"\"\"\n    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏\n    \"\"\"\n    return {\n        \"total_connections\": len(business_owners),\n        \"business_owners\": business_owners,\n        \"filter_status\": \"‚úÖ –ê–ö–¢–ò–í–ù–ê\" if business_owners else \"‚ö†Ô∏è –ù–ï–ê–ö–¢–ò–í–ù–ê\",\n        \"description\": \"–°–ø–∏—Å–æ–∫ ID –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤, —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥—É—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º\",\n        \"current_time\": datetime.now().isoformat()\n    }\n```\n\n### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\n\n```python\nimport logging\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.FileHandler('business_filter.log', encoding='utf-8'),\n        logging.StreamHandler()\n    ]\n)\n\nlogger = logging.getLogger(__name__)\n```\n\n---\n\n## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n\n### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n\n1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Business Connection**\n   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ `business_owners`\n   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n\n2. **–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞**\n   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç\n   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: \"‚úÖ –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\"\n\n3. **–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞**\n   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –±–æ—Ç –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç\n   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: \"üö´ –ò–ì–ù–û–†–ò–†–£–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞\"\n\n4. **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ Business Connection**\n   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ `business_owners`\n   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è\n\n### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:\n\n```python\ndef test_owner_filter():\n    # –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ\n    business_connection_event = {\n        \"business_connection\": {\n            \"id\": \"test_connection_123\",\n            \"user\": {\n                \"id\": 987654321,\n                \"first_name\": \"Test Owner\"\n            },\n            \"is_enabled\": True\n        }\n    }\n    handle_business_connection(business_connection_event)\n    assert \"test_connection_123\" in business_owners\n    \n    # –¢–µ—Å—Ç 2: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞\n    owner_message = {\n        \"business_message\": {\n            \"from\": {\"id\": 987654321, \"first_name\": \"Test Owner\"},\n            \"text\": \"–ü—Ä–∏–≤–µ—Ç –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞\",\n            \"business_connection_id\": \"test_connection_123\",\n            \"chat\": {\"id\": 123456}\n        }\n    }\n    result = handle_business_message(owner_message)\n    assert result[\"action\"] == \"ignored_owner_message\"\n    \n    # –¢–µ—Å—Ç 3: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\n    client_message = {\n        \"business_message\": {\n            \"from\": {\"id\": 111222333, \"first_name\": \"Client\"},\n            \"text\": \"–ü—Ä–∏–≤–µ—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\",\n            \"business_connection_id\": \"test_connection_123\",\n            \"chat\": {\"id\": 123456}\n        }\n    }\n    result = handle_business_message(client_message)\n    assert result[\"action\"] != \"ignored_owner_message\"\n    \n    print(\"‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!\")\n```\n\n---\n\n## üö® Troubleshooting\n\n### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:\n\n#### 1. –ë–æ—Ç –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞\n\n**–ü—Ä–∏—á–∏–Ω—ã:**\n- Business Connection –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ `business_owners`\n- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ID (—Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö)\n- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `business_connection_id` –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏\n\n**–†–µ—à–µ–Ω–∏–µ:**\n```python\n# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏\nlogging.info(f\"business_owners: {business_owners}\")\nlogging.info(f\"user_id: {user_id} (type: {type(user_id)})\")\nlogging.info(f\"owner_id: {owner_id} (type: {type(owner_id)})\")\n\n# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–æ–∫–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ\nif str(user_id) == str(owner_id):\n```\n\n#### 2. Business Connection –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è\n\n**–ü—Ä–∏—á–∏–Ω—ã:**\n- Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è `business_connection`\n- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `business_connection` –≤ `allowed_updates`\n\n**–†–µ—à–µ–Ω–∏–µ:**\n```python\n# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook\nallowed_updates = [\n    \"business_connection\",  # ‚Üê –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!\n    \"business_message\"\n]\n```\n\n#### 3. –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Business API\n\n**–ü—Ä–∏—á–∏–Ω—ã:**\n- Business API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Telegram\n- –ù–µ—Ç Premium –ø–æ–¥–ø–∏—Å–∫–∏\n- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `business_connection_id`\n\n**–†–µ—à–µ–Ω–∏–µ:**\n1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Telegram: Settings ‚Üí Business ‚Üí Chatbots\n2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –Ω–∞–ª–∏—á–∏–∏ Premium –ø–æ–¥–ø–∏—Å–∫–∏\n3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook\n\n---\n\n## üìö –ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –∫–æ–¥–∞\n\n### –ü–æ–ª–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è FastAPI\n\n```python\nfrom fastapi import FastAPI, Request\nfrom collections import deque\nimport logging\nimport json\n\nclass BusinessOwnerFilter:\n    def __init__(self):\n        self.business_owners = {}  # {connection_id: owner_id}\n        self.last_updates = deque(maxlen=10)\n        self.update_counter = 0\n        \n        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\n        self.logger = logging.getLogger(self.__class__.__name__)\n        \n    def handle_business_connection(self, conn_data):\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ Business Connection —Å–æ–±—ã—Ç–∏–π\"\"\"\n        is_enabled = conn_data.get(\"is_enabled\", False)\n        connection_id = conn_data.get(\"id\")\n        user_info = conn_data.get(\"user\", {})\n        owner_user_id = user_info.get(\"id\")\n        user_name = user_info.get(\"first_name\", \"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\")\n        \n        if connection_id and owner_user_id:\n            if is_enabled:\n                self.business_owners[connection_id] = owner_user_id\n                self.logger.info(f\"‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤–ª–∞–¥–µ–ª–µ—Ü: {user_name} (ID: {owner_user_id})\")\n            else:\n                self.business_owners.pop(connection_id, None)\n                self.logger.info(f\"‚ùå –£–¥–∞–ª–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü: {user_name}\")\n                \n    def is_owner_message(self, user_id, business_connection_id):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞?\"\"\"\n        if not business_connection_id or business_connection_id not in self.business_owners:\n            return False\n            \n        owner_id = self.business_owners[business_connection_id]\n        return str(user_id) == str(owner_id)\n        \n    def process_business_message(self, message_data):\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ Business —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π\"\"\"\n        user_id = message_data.get(\"from\", {}).get(\"id\")\n        business_connection_id = message_data.get(\"business_connection_id\")\n        user_name = message_data.get(\"from\", {}).get(\"first_name\", \"–ö–ª–∏–µ–Ω—Ç\")\n        \n        if self.is_owner_message(user_id, business_connection_id):\n            self.logger.info(f\"üö´ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞: {user_name}\")\n            return {\"ok\": True, \"action\": \"ignored_owner_message\"}\n            \n        self.logger.info(f\"‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞: {user_name}\")\n        return self.handle_client_message(message_data)\n        \n    def handle_client_message(self, message_data):\n        \"\"\"–í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤\"\"\"\n        # –†–µ–∞–ª–∏–∑—É–π—Ç–µ –≤–∞—à—É –ª–æ–≥–∏–∫—É –∑–¥–µ—Å—å\n        pass\n        \n    def get_status(self):\n        \"\"\"–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ñ–∏–ª—å—Ç—Ä–∞\"\"\"\n        return {\n            \"total_connections\": len(self.business_owners),\n            \"business_owners\": self.business_owners,\n            \"filter_active\": len(self.business_owners) > 0\n        }\n\n# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ\napp = FastAPI()\nfilter_manager = BusinessOwnerFilter()\n\n@app.post(\"/webhook\")\nasync def webhook(request: Request):\n    update_dict = await request.json()\n    \n    if \"business_connection\" in update_dict:\n        filter_manager.handle_business_connection(update_dict[\"business_connection\"])\n        \n    elif \"business_message\" in update_dict:\n        return filter_manager.process_business_message(update_dict[\"business_message\"])\n        \n    return {\"ok\": True}\n\n@app.get(\"/status\")\nasync def get_filter_status():\n    return filter_manager.get_status()\n```\n\n### –®–∞–±–ª–æ–Ω –¥–ª—è aiogram 3.x\n\n```python\nfrom aiogram import Bot, Dispatcher, types\nfrom aiogram.filters import BaseFilter\n\nclass BusinessOwnerFilter(BaseFilter):\n    def __init__(self):\n        self.business_owners = {}\n        \n    async def __call__(self, message: types.Message) -> bool:\n        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ù–ï –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞\n        if hasattr(message, 'business_connection_id'):\n            business_connection_id = message.business_connection_id\n            user_id = message.from_user.id\n            \n            if business_connection_id in self.business_owners:\n                owner_id = self.business_owners[business_connection_id]\n                if str(user_id) == str(owner_id):\n                    return False  # –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞\n                    \n        return True  # –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ\n\n# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ\nbot = Bot(token=\"YOUR_TOKEN\")\ndp = Dispatcher()\nbusiness_filter = BusinessOwnerFilter()\n\n@dp.business_connection()\nasync def handle_business_connection(business_connection: types.BusinessConnection):\n    if business_connection.is_enabled:\n        business_filter.business_owners[business_connection.id] = business_connection.user.id\n    else:\n        business_filter.business_owners.pop(business_connection.id, None)\n\n@dp.business_message(business_filter)\nasync def handle_business_message(message: types.Message):\n    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤\n    await message.answer(f\"–ü—Ä–∏–≤–µ—Ç! –ü–æ–ª—É—á–∏–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message.text}\")\n```\n\n---\n\n## üîÑ –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ frameworks\n\n### Django + Django REST Framework\n\n```python\nfrom django.http import JsonResponse\nfrom django.views.decorators.csrf import csrf_exempt\nfrom django.utils.decorators import method_decorator\nfrom django.views import View\nimport json\n\n@method_decorator(csrf_exempt, name='dispatch')\nclass WebhookView(View):\n    business_owners = {}  # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    \n    def post(self, request):\n        update_dict = json.loads(request.body)\n        \n        if \"business_connection\" in update_dict:\n            self.handle_business_connection(update_dict[\"business_connection\"])\n            \n        elif \"business_message\" in update_dict:\n            return self.handle_business_message(update_dict[\"business_message\"])\n            \n        return JsonResponse({\"ok\": True})\n        \n    def handle_business_connection(self, conn_data):\n        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –ø—Ä–∏–º–µ—Ä–∞–º –≤—ã—à–µ\n        pass\n        \n    def handle_business_message(self, message_data):\n        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–∏–º–µ—Ä–∞–º –≤—ã—à–µ\n        pass\n```\n\n### Flask\n\n```python\nfrom flask import Flask, request, jsonify\n\napp = Flask(__name__)\nbusiness_owners = {}\n\n@app.route('/webhook', methods=['POST'])\ndef webhook():\n    update_dict = request.get_json()\n    \n    if \"business_connection\" in update_dict:\n        handle_business_connection(update_dict[\"business_connection\"])\n        \n    elif \"business_message\" in update_dict:\n        return handle_business_message(update_dict[\"business_message\"])\n        \n    return jsonify({\"ok\": True})\n\ndef handle_business_connection(conn_data):\n    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –ø—Ä–∏–º–µ—Ä–∞–º –≤—ã—à–µ\n    pass\n    \ndef handle_business_message(message_data):\n    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –ø—Ä–∏–º–µ—Ä–∞–º –≤—ã—à–µ\n    pass\n```\n\n---\n\n## üíæ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö\n\n### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n\n```python\n# –ú–æ–¥–µ–ª—å –¥–ª—è Django\nfrom django.db import models\n\nclass BusinessConnection(models.Model):\n    connection_id = models.CharField(max_length=255, unique=True)\n    owner_user_id = models.BigIntegerField()\n    owner_name = models.CharField(max_length=255)\n    is_enabled = models.BooleanField(default=True)\n    created_at = models.DateTimeField(auto_now_add=True)\n    updated_at = models.DateTimeField(auto_now=True)\n    \n    class Meta:\n        db_table = 'business_connections'\n\n# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ\ndef handle_business_connection(conn_data):\n    connection_id = conn_data.get(\"id\")\n    owner_user_id = conn_data.get(\"user\", {}).get(\"id\")\n    owner_name = conn_data.get(\"user\", {}).get(\"first_name\", \"\")\n    is_enabled = conn_data.get(\"is_enabled\", False)\n    \n    if is_enabled:\n        BusinessConnection.objects.update_or_create(\n            connection_id=connection_id,\n            defaults={\n                'owner_user_id': owner_user_id,\n                'owner_name': owner_name,\n                'is_enabled': is_enabled\n            }\n        )\n    else:\n        BusinessConnection.objects.filter(connection_id=connection_id).delete()\n        \ndef is_owner_message(user_id, business_connection_id):\n    try:\n        connection = BusinessConnection.objects.get(\n            connection_id=business_connection_id,\n            is_enabled=True\n        )\n        return str(user_id) == str(connection.owner_user_id)\n    except BusinessConnection.DoesNotExist:\n        return False\n```\n\n### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis\n\n```python\nimport redis\nimport json\n\nredis_client = redis.Redis(host='localhost', port=6379, db=0)\n\ndef save_business_owner(connection_id, owner_id, owner_name):\n    data = {\n        'owner_id': owner_id,\n        'owner_name': owner_name,\n        'timestamp': datetime.now().isoformat()\n    }\n    redis_client.set(f\"business_owner:{connection_id}\", json.dumps(data))\n    \ndef get_business_owner(connection_id):\n    data = redis_client.get(f\"business_owner:{connection_id}\")\n    if data:\n        return json.loads(data)\n    return None\n    \ndef remove_business_owner(connection_id):\n    redis_client.delete(f\"business_owner:{connection_id}\")\n    \ndef is_owner_message(user_id, business_connection_id):\n    owner_data = get_business_owner(business_connection_id)\n    if owner_data:\n        return str(user_id) == str(owner_data['owner_id'])\n    return False\n```\n\n---\n\n## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞\n\n### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è\n\n```python\nfrom collections import defaultdict\nfrom datetime import datetime, timedelta\n\nclass BusinessFilterAnalytics:\n    def __init__(self):\n        self.stats = {\n            'owner_messages_ignored': 0,\n            'client_messages_processed': 0,\n            'connections_created': 0,\n            'connections_removed': 0,\n            'daily_stats': defaultdict(lambda: {\n                'owner_ignored': 0,\n                'client_processed': 0\n            })\n        }\n    \n    def log_owner_message_ignored(self):\n        self.stats['owner_messages_ignored'] += 1\n        today = datetime.now().strftime('%Y-%m-%d')\n        self.stats['daily_stats'][today]['owner_ignored'] += 1\n        \n    def log_client_message_processed(self):\n        self.stats['client_messages_processed'] += 1\n        today = datetime.now().strftime('%Y-%m-%d')\n        self.stats['daily_stats'][today]['client_processed'] += 1\n        \n    def get_daily_report(self, date=None):\n        if date is None:\n            date = datetime.now().strftime('%Y-%m-%d')\n        return self.stats['daily_stats'][date]\n        \n    def get_weekly_report(self):\n        week_ago = datetime.now() - timedelta(days=7)\n        weekly_stats = {'owner_ignored': 0, 'client_processed': 0}\n        \n        for i in range(7):\n            date = (week_ago + timedelta(days=i)).strftime('%Y-%m-%d')\n            day_stats = self.stats['daily_stats'][date]\n            weekly_stats['owner_ignored'] += day_stats['owner_ignored']\n            weekly_stats['client_processed'] += day_stats['client_processed']\n            \n        return weekly_stats\n```\n\n---\n\n## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n\n### –ü—Ä–æ–≤–µ—Ä–∫–∞ Secret Token\n\n```python\nimport hmac\nimport hashlib\n\ndef verify_webhook_signature(request_body, secret_token, received_signature):\n    \"\"\"\n    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n    \"\"\"\n    expected_signature = hmac.new(\n        secret_token.encode(),\n        request_body,\n        hashlib.sha256\n    ).hexdigest()\n    \n    return hmac.compare_digest(expected_signature, received_signature)\n\n# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ FastAPI\n@app.post(\"/webhook\")\nasync def webhook(request: Request):\n    secret_token = \"YOUR_SECRET_TOKEN\"\n    body = await request.body()\n    signature = request.headers.get(\"X-Telegram-Bot-Api-Secret-Token\")\n    \n    if not signature or not verify_webhook_signature(body, secret_token, signature):\n        raise HTTPException(status_code=403, detail=\"Invalid signature\")\n    \n    update_dict = json.loads(body)\n    # –î–∞–ª—å—à–µ –æ–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...\n```\n\n### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ IP\n\n```python\n# –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤ Telegram\nTELEGRAM_IPS = [\n    \"149.154.160.0/20\",\n    \"91.108.4.0/22\",\n    # ... –¥—Ä—É–≥–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã Telegram\n]\n\ndef is_telegram_ip(ip_address):\n    import ipaddress\n    \n    ip = ipaddress.ip_address(ip_address)\n    for network in TELEGRAM_IPS:\n        if ip in ipaddress.ip_network(network):\n            return True\n    return False\n\n@app.post(\"/webhook\")\nasync def webhook(request: Request):\n    client_ip = request.client.host\n    \n    if not is_telegram_ip(client_ip):\n        raise HTTPException(status_code=403, detail=\"Forbidden\")\n    \n    # –î–∞–ª—å—à–µ –æ–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...\n```\n\n---\n\n## üìä –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤\n\n### –£—Å–ø–µ—à–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–∞\n\n```\n2024-01-20 12:00:00 - INFO - ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü Business Connection: –ò–≤–∞–Ω (ID: 123456789) –¥–ª—è connection_id: conn_abc123\n2024-01-20 12:01:15 - INFO - üìä Business message - connection_id: 'conn_abc123'\n2024-01-20 12:01:15 - INFO - üë§ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç: –ò–≤–∞–Ω (ID: 123456789)\n2024-01-20 12:01:15 - INFO - üö´ –ò–ì–ù–û–†–ò–†–£–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∞–∫–∫–∞—É–Ω—Ç–∞: –ò–≤–∞–Ω (ID: 123456789)\n2024-01-20 12:01:15 - INFO - üí¨ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!'\n\n2024-01-20 12:02:30 - INFO - üìä Business message - connection_id: 'conn_abc123'\n2024-01-20 12:02:30 - INFO - üë§ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç: –ö–ª–∏–µ–Ω—Ç (ID: 987654321)\n2024-01-20 12:02:30 - INFO - ‚úÖ –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞: –ö–ª–∏–µ–Ω—Ç (ID: 987654321)\n2024-01-20 12:02:31 - INFO - ‚úÖ Business API: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ HTTP API\n```\n\n### –ü—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞\n\n```\n# –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Business Connection\n2024-01-20 12:03:00 - WARNING - ‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü –¥–ª—è connection_id: conn_xyz789. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ.\n2024-01-20 12:03:00 - INFO - üìä –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–ª–∞–¥–µ–ª—å—Ü—ã: ['conn_abc123']\n\n# –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç connection_id –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏\n2024-01-20 12:04:00 - WARNING - ‚ö†Ô∏è Business message –±–µ–∑ connection_id –æ—Ç –ö–ª–∏–µ–Ω—Ç (987654321)\n\n# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Business Connection\n2024-01-20 12:05:00 - INFO - ‚ùå –£–¥–∞–ª–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü Business Connection: –ò–≤–∞–Ω (connection_id: conn_abc123)\n2024-01-20 12:05:00 - INFO - ‚ùå –û—Ç–∫–ª—é—á–µ–Ω –∫ Business –∞–∫–∫–∞—É–Ω—Ç—É: –ò–≤–∞–Ω\n2024-01-20 12:05:00 - INFO - üìä –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö Business Connection: 0\n```\n\n---\n\n## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è\n\n### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞\n- [ ] –£–±–µ–¥–∏—Ç—å—Å—è –≤ –Ω–∞–ª–∏—á–∏–∏ Telegram Premium —É –≤–ª–∞–¥–µ–ª—å—Ü–∞\n- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Business API –≤ Telegram: Settings ‚Üí Business ‚Üí Chatbots\n- [ ] –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞\n- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook —Å–µ—Ä–≤–µ—Ä\n\n### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è\n- [ ] –°–æ–∑–¥–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ `business_owners`\n- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `business_connection` —Å–æ–±—ã—Ç–∏–π\n- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `is_message_from_owner()`\n- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `business_message`\n- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Business API\n\n### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook\n- [ ] –î–æ–±–∞–≤–∏—Ç—å `business_connection` –≤ `allowed_updates`\n- [ ] –î–æ–±–∞–≤–∏—Ç—å `business_message` –≤ `allowed_updates`\n- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏\n- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å secret_token –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n\n### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n- [ ] –ü–æ–¥–∫–ª—é—á–∏—Ç—å Business Connection\n- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–¥–æ–ª–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è)\n- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–¥–æ–ª–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è)\n- [ ] –û—Ç–∫–ª—é—á–∏—Ç—å Business Connection\n- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å\n\n### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\n- [ ] –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ `/debug/business-owners`\n- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö\n- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n\n### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ secret_token –≤ webhook\n- [ ] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ IP –∞–¥—Ä–µ—Å–∞–º Telegram\n- [ ] –ó–∞—â–∏—Ç–∞ endpoint'–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n---\n\n## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n\n–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ Telegram Business API. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö API –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ.\n\n### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:\n- [Telegram Bot API](https://core.telegram.org/bots/api)\n- [Telegram Business Features](https://core.telegram.org/bots/features#telegram-business)\n- [Webhook Guide](https://core.telegram.org/bots/webhooks)\n\n---\n\n**–ê–≤—Ç–æ—Ä:** Claude Code\n**–í–µ—Ä—Å–∏—è:** 1.0\n**–î–∞—Ç–∞:** 2024-01-20\n\n*–î–∞–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è \"–∫–∞–∫ –µ—Å—Ç—å\" –∏ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω—É–∂–¥—ã –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.*"