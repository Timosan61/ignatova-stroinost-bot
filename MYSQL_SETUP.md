# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MySQL –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–ø–∏—Å–æ–∫

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –≤ MySQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:
- ‚úÖ –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Business API —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–µ–π
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –≤–ª–æ–∂–µ–Ω–∏—è—Ö

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ Railway

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å MySQL –ø–ª–∞–≥–∏–Ω

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –Ω–∞ Railway
2. –ù–∞–∂–º–∏—Ç–µ **"New" ‚Üí "Database" ‚Üí "Add MySQL"**
3. Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç MySQL —Å–µ—Ä–≤–∏—Å

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ. –í–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É:

**–§–æ—Ä–º–∞—Ç DATABASE_URL:**
```
DATABASE_URL=mysql+pymysql://[user]:[password]@[host]:[port]/[database]
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç Railway MySQL:**
- `MYSQL_USER` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `MYSQL_PASSWORD` - –ø–∞—Ä–æ–ª—å
- `MYSQL_HOST` - —Ö–æ—Å—Ç (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
- `MYSQL_PORT` - –ø–æ—Ä—Ç
- `MYSQL_DATABASE` - –∏–º—è –±–∞–∑—ã

**–°–∫–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ –∏—Ö –≤ DATABASE_URL:**
```bash
DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DATABASE}
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
DATABASE_URL=mysql+pymysql://root:password123@mysql.railway.internal:3306/railway
```

### –®–∞–≥ 3: Redeploy –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `DATABASE_URL`:
1. Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ –¥–µ–ø–ª–æ–∏—Ç –±–æ—Ç
2. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞: `telegram_chats`

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–∞—Ö:
- `telegram_chat_id` - ID —á–∞—Ç–∞ –≤ Telegram
- `username`, `first_name`, `last_name` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `is_business_chat` - —Ñ–ª–∞–≥ Business API —á–∞—Ç–∞
- `total_messages`, `total_voice_messages` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `last_message_at` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### –¢–∞–±–ª–∏—Ü–∞: `telegram_messages`

–•—Ä–∞–Ω–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
- `telegram_message_id` - ID —Å–æ–æ–±—â–µ–Ω–∏—è
- `chat_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç
- `text` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- `voice_transcript` - —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
- `is_voice_message` - —Ñ–ª–∞–≥ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `is_from_business` - —Ñ–ª–∞–≥ Business —Å–æ–æ–±—â–µ–Ω–∏—è
- `bot_response_text` - –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
- `ai_model_used` - –º–æ–¥–µ–ª—å AI (gpt-4o/claude)
- `has_attachments`, `attachments_meta` - –≤–ª–æ–∂–µ–Ω–∏—è

## üîç API Endpoints –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î –¥–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ endpoints:

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ë–î
```
GET /api/health/db
```

### –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
```
GET /api/chats?skip=0&limit=50&business_only=false
```

### –î–µ—Ç–∞–ª–∏ —á–∞—Ç–∞
```
GET /api/chats/{chat_id}
```

### –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞
```
GET /api/chats/{chat_id}/messages?skip=0&limit=50
```

### –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
```
GET /api/search?q=—Ç–µ–∫—Å—Ç&skip=0&limit=50
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```
GET /api/stats
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```bash
# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã
curl https://your-app.railway.app/api/chats

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —á–∞—Ç–∞ ID 5
curl https://your-app.railway.app/api/chats/5/messages?limit=10

# –ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤—É "–ø—Ä–∏–≤–µ—Ç"
curl https://your-app.railway.app/api/search?q=–ø—Ä–∏–≤–µ—Ç

# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl https://your-app.railway.app/api/stats
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SQLAlchemy ORM –∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ. **–ù–ï –Ω—É–∂–Ω–æ** –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã.

### Zep Cloud + MySQL

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö **–¥—É–±–ª–∏—Ä—É–µ—Ç** –¥–∞–Ω–Ω—ã–µ –∏–∑ Zep Cloud:
- **Zep Cloud**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è AI-–ø–∞–º—è—Ç–∏ –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
- **MySQL**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

–û–±–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏ –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É.

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ë–î

–ï—Å–ª–∏ `DATABASE_URL` –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:
- –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –°–æ–æ–±—â–µ–Ω–∏—è –ù–ï –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ MySQL
- Zep Cloud –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –í –ª–æ–≥–∞—Ö: "‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫–ª—é—á–µ–Ω–∞"

## üêõ –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### "Database not available" –≤ API
**–ü—Ä–∏—á–∏–Ω–∞:** DATABASE_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤—å—Ç–µ DATABASE_URL –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway

### "Lock wait timeout" –≤ –ª–æ–≥–∞—Ö
**–ü—Ä–∏—á–∏–Ω–∞:** –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
**–†–µ—à–µ–Ω–∏–µ:** –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å exponential backoff - –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–æ–∂–¥–∏—Ç–µ

### –¢–∞–±–ª–∏—Ü—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π DATABASE_URL
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç: `mysql+pymysql://user:pass@host:port/database`

### Connection timeout
**–ü—Ä–∏—á–∏–Ω–∞:** Railway MySQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ MySQL –ø–ª–∞–≥–∏–Ω –∑–∞–ø—É—â–µ–Ω –≤ Railway

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ë–î:
```bash
curl https://your-app.railway.app/api/health/db
```

–û—Ç–≤–µ—Ç:
```json
{
  "status": "enabled",
  "message": "Database is configured and running"
}
```

### –õ–æ–≥–∏ Railway:
```
üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
üíæ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ò–≤–∞–Ω
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏–∏ (–±—É–¥—É—â–µ–µ)

–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —á–µ—Ä–µ–∑ SQLAlchemy.

–î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Alembic:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
pip install alembic

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
alembic init alembic

# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic revision --autogenerate -m "Initial tables"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
alembic upgrade head
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–∑:** GPTIFOBIZ architecture
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è SQLAlchemy:** https://docs.sqlalchemy.org/
**Railway MySQL:** https://docs.railway.app/databases/mysql

**–í–æ–ø—Ä–æ—Å—ã?** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ issue –Ω–∞ GitHub.
